```markdown
# 🔧 ASP.NET Core Identity + JWT 登录失败问题总结与修复方案

## ❗ 问题核心
你的应用同时启用了 **Cookie 身份认证（ASP.NET Core Identity）** 和 **JWT Bearer 认证**，但登录成功后浏览器未收到 `.AspNetCore.Identity.Application` Cookie，导致 `User.Identity.IsAuthenticated == false`。

---

## 🧨 根本原因

```csharp
builder.Services.AddAuthentication(options =>
{
    options.DefaultAuthenticateScheme = JwtBearerDefaults.AuthenticationScheme;
    options.DefaultChallengeScheme = JwtBearerDefaults.AuthenticationScheme;
    options.DefaultScheme = JwtBearerDefaults.AuthenticationScheme;
})
```

- 默认认证方案被设置为 JWT Bearer，而非 Cookie。
- Identity 的登录机制依赖 Cookie，但认证中间件不会处理 Cookie 登录状态。

---

## ✅ 正确做法：支持多种认证方案

### ✅ 第一步：修改 `AddAuthentication`，保留 Cookie 为默认方案

```csharp
builder.Services.AddAuthentication(options =>
{
    options.DefaultScheme = IdentityConstants.ApplicationScheme; // Cookie
    options.DefaultSignInScheme = IdentityConstants.ApplicationScheme;
    options.DefaultChallengeScheme = IdentityConstants.ApplicationScheme;
})
.AddJwtBearer(options =>
{
    options.TokenValidationParameters = new TokenValidationParameters
    {
        ValidateIssuer = false,
        ValidateAudience = false,
        ValidateLifetime = true,
        ValidateIssuerSigningKey = true,
        IssuerSigningKey = new SymmetricSecurityKey(Encoding.UTF8.GetBytes(secretKey))
    };
});
```

---

### ✅ 第二步：在 API 控制器中显式指定 JWT 认证

```csharp
[Authorize(AuthenticationSchemes = JwtBearerDefaults.AuthenticationScheme)]
public class MyApiController : ControllerBase
{
    // 只接受 JWT
}
```

或使用策略：

```csharp
builder.Services.AddAuthorization(options =>
{
    options.AddPolicy("RequireJwt", policy =>
    {
        policy.AuthenticationSchemes.Add(JwtBearerDefaults.AuthenticationScheme);
        policy.RequireAuthenticatedUser();
    });
});
```

```csharp
[Authorize(Policy = "RequireJwt")]
```

---

### ✅ 第三步（推荐）：确保 Identity UI 使用 Cookie 登录

- Identity 的登录、注册等页面必须使用 Cookie 认证。
- 不要让 JWT 成为全局默认方案，除非你完全不用 Cookie 登录。

---

## ✅ 验证修复效果

1. 清除浏览器所有 Cookie。
2. 访问 `/Identity/Account/Login`，输入账号密码登录。
3. 登录后应跳转到首页，顶部显示用户名 + “登出”。
4. 打开开发者工具 → Application → Cookies，确认存在：
   - 名称：`.AspNetCore.Identity.Application`
   - 值：非空
5. 同时，API 仍可通过 `Authorization: Bearer xxx` 正常访问（只要加了 `[Authorize(AuthenticationSchemes = JwtBearerDefaults.AuthenticationScheme)]`）。

---

## 🔒 补充建议

| 场景 | 建议 |
|------|------|
| 只做 Web 应用（无 API） | 移除 JWT 配置 |
| 混合使用 Web + API | 按上述方式配置多方案认证 |

---

## ✅ 总结

| 问题原因 | 解决方案 |
|----------|----------|
| `DefaultScheme = JwtBearer` 导致 Cookie 登录无效 | 改为 `DefaultScheme = IdentityConstants.ApplicationScheme` |
| Identity 登录后无 Cookie | 确保认证中间件能处理 Cookie |
| 页面不显示用户信息 | 因为 `User` 实际未认证 |

完成上述修改后，你的登录功能应该就能正常显示用户名了！

如需进一步帮助（比如如何保护特定 API 路由），欢迎继续提问。
```