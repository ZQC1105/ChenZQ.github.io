æ˜¯çš„ï¼âœ… å®Œå…¨æ­£ç¡®ã€‚

ğŸ” User.FindFirstValue(ClaimTypes.NameIdentifier) çš„æœ¬è´¨ï¼š

å®ƒ ç›´æ¥ä»å½“å‰ HTTP è¯·æ±‚çš„è®¤è¯ç¥¨æ®ï¼ˆAuthentication Ticketï¼‰ä¸­è¯»å– Claimï¼Œè€Œè¿™ä¸ªç¥¨æ®æ¥æºå–å†³äºä½ ä½¿ç”¨çš„è®¤è¯æ–¹å¼ï¼š

è®¤è¯æ–¹å¼ ç¥¨æ®å­˜å‚¨ä½ç½® User æ•°æ®æ¥æº
-------- ------------ ----------------
Cookie è®¤è¯ï¼ˆIdentity é»˜è®¤ï¼‰ æµè§ˆå™¨ Cookieï¼ˆå¦‚ .AspNetCore.Identity.Applicationï¼‰ è§£å¯† Cookie åå¾—åˆ°çš„ Claims
JWT Bearer è®¤è¯ HTTP Header Authorization: Bearer <token> è§£ç å¹¶éªŒè¯ JWT åæå–çš„ Claims
ğŸ“Œ Userï¼ˆå³ HttpContext.Userï¼‰æ˜¯ä¸€ä¸ª ClaimsPrincipal å¯¹è±¡ï¼Œå®ƒåœ¨è¯·æ±‚è¿›å…¥æ—¶ç”± ASP.NET Core çš„è®¤è¯ä¸­é—´ä»¶ï¼ˆAuthentication Middlewareï¼‰è‡ªåŠ¨å¡«å……ã€‚

æ‰€ä»¥ï¼š

csharp
string? userId = User.FindFirstValue(ClaimTypes.NameIdentifier);

è¿™è¡Œä»£ç ï¼š
ä¸è®¿é—®æ•°æ®åº“
ä¸è°ƒç”¨ UserManager
åªæ˜¯ä»å†…å­˜ä¸­å·²è§£æçš„ Claims é‡Œæ‰¾ä¸€ä¸ªå€¼
æ€§èƒ½æé«˜ï¼ˆO(1) æˆ– O(n) éå†å°‘é‡ Claimsï¼‰

ğŸ§ª ä¸¾ä¸ªä¾‹å­
åœºæ™¯ 1ï¼šCookie ç™»å½•
ç”¨æˆ·ç™»å½•åï¼ŒæœåŠ¡å™¨ç”ŸæˆåŠ å¯† Cookieï¼Œé‡Œé¢åŒ…å«ï¼š
json
{
"claims": [
{ "type": "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/nameidentifier", "value": "64b4ef52-..." },
{ "type": "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/name", "value": "123" }
]
}
ä¸‹æ¬¡è¯·æ±‚æ—¶ï¼Œæµè§ˆå™¨è‡ªåŠ¨å¸¦ä¸Š Cookie
ASP.NET Core è§£å¯† Cookie â†’ æ„é€  ClaimsPrincipal â†’ èµ‹å€¼ç»™ HttpContext.User
ä½ çš„ä»£ç è°ƒç”¨ FindFirstValue(...) â†’ ç›´æ¥è¿”å› "64b4ef52-..."
åœºæ™¯ 2ï¼šJWT ç™»å½•
å®¢æˆ·ç«¯åœ¨ Header ä¸­å‘é€ï¼š
http
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.xxxxx
JWT Payloadï¼ˆè§£ç åï¼‰åŒ…å«ï¼š
json
{
"nameid": "64b4ef52-...",
"unique_name": "123",
"exp": 1730000000
}
ï¼ˆå…¶ä¸­ nameid æ˜¯ ClaimTypes.NameIdentifier çš„ç®€å†™å½¢å¼ï¼‰
ASP.NET Core éªŒè¯ JWT â†’ æå– Claims â†’ æ„é€  ClaimsPrincipal
ä½ çš„ä»£ç åŒæ ·é€šè¿‡ FindFirstValue(...) æ‹¿åˆ° "64b4ef52-..."

âœ… æ€»ç»“ä¸€å¥è¯ï¼š
User.FindFirstValue(ClaimTypes.NameIdentifier) å°±æ˜¯ä»å½“å‰è¯·æ±‚çš„è®¤è¯å‡­è¯ï¼ˆCookie æˆ– JWTï¼‰ä¸­ç›´æ¥è¯»å–ç”¨æˆ· IDï¼Œä¸æŸ¥åº“ã€ä¸è®¡ç®—ã€é›¶å¼€é”€ã€‚

ğŸ’¡ ä½¿ç”¨å»ºè®®ï¼š
ä¼˜å…ˆä½¿ç”¨è¿™ç§æ–¹å¼è·å–ç”¨æˆ· IDï¼Œè€Œä¸æ˜¯ _userManager.GetUserAsync(User)ï¼ˆåè€…ä¼šæŸ¥æ•°æ®åº“ï¼‰
ç¡®ä¿åœ¨ç”Ÿæˆè®¤è¯å‡­è¯æ—¶æ­£ç¡®å†™å…¥äº†è¯¥ Claimï¼š
Cookieï¼šIdentity è‡ªåŠ¨å¤„ç† âœ…
JWTï¼šä½ å¿…é¡»æ‰‹åŠ¨æ·»åŠ  new Claim(ClaimTypes.NameIdentifier, user.Id) âœ…

è¿™æ ·ä½ çš„ç³»ç»Ÿå°±èƒ½é«˜æ•ˆã€ä¸€è‡´åœ°å·¥ä½œåœ¨æ··åˆè®¤è¯ç¯å¢ƒä¸‹ã€‚
