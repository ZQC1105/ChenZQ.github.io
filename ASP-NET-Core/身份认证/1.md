éå¸¸å¥½çš„é—®é¢˜ï¼æˆ‘ä»¬æ¥è¯¦ç»†è§£é‡Šè¿™å¥è¯çš„å«ä¹‰å’ŒèƒŒåçš„å®è·µé€»è¾‘ï¼š

ğŸ“Œ åŸè¯å›é¡¾ï¼š
â€œå¦‚æœä½ åŒæ—¶æ”¯æŒ Cookie + JWTï¼Œå»ºè®®ç»Ÿä¸€ä½¿ç”¨ ClaimTypes.NameIdentifierã€‚â€

æ„æ€æ˜¯ï¼š
æ— è®ºç”¨æˆ·æ˜¯é€šè¿‡ä¼ ç»Ÿçš„ Cookie ç™»å½•ï¼ˆå¦‚ç½‘é¡µè¡¨å•ç™»å½•ï¼‰ï¼Œè¿˜æ˜¯é€šè¿‡ JWT Token ç™»å½•ï¼ˆå¦‚ API è°ƒç”¨ï¼‰ï¼Œåœ¨ä½ çš„ä¸šåŠ¡ä»£ç ä¸­ï¼Œéƒ½åº”è¯¥ç”¨åŒä¸€ä¸ªæ–¹å¼æ¥è·å–ç”¨æˆ· ID â€”â€” å³ User.FindFirstValue(ClaimTypes.NameIdentifier)ã€‚

ğŸ” ä¸ºä»€ä¹ˆéœ€è¦â€œç»Ÿä¸€â€ï¼Ÿ

å‡è®¾ä½ çš„ç³»ç»Ÿæ—¢æä¾›ï¼š
Web é¡µé¢ï¼ˆä½¿ç”¨ ASP.NET Core Identity çš„ Cookie è®¤è¯ï¼‰
API æ¥å£ï¼ˆä¾› App æˆ–å‰ç«¯è°ƒç”¨ï¼Œä½¿ç”¨ JWT Bearer è®¤è¯ï¼‰

é‚£ä¹ˆä½ å¯èƒ½ä¼šåœ¨ä¸åŒåœ°æ–¹å†™è¿™æ ·çš„ä»£ç ï¼š

csharp
// åœ¨ Web Controller ä¸­ï¼ˆCookie ç™»å½•ï¼‰
var userId = User.FindFirstValue(ClaimTypes.NameIdentifier); // âœ… æ­£å¸¸å·¥ä½œ

// åœ¨ API Controller ä¸­ï¼ˆJWT ç™»å½•ï¼‰
var userId = User.FindFirstValue(JwtRegisteredClaimNames.Sub); // âŒ ä¸ä¸€è‡´ï¼

è¿™å°±å¯¼è‡´ï¼š
ä»£ç é‡å¤ã€éš¾ä»¥ç»´æŠ¤
å¦‚æœæŸå¤©è¦æ”¹è®¤è¯æ–¹å¼ï¼Œå¤§é‡åœ°æ–¹è¦æ”¹
å…¬å…±æœåŠ¡ï¼ˆå¦‚æ—¥å¿—ã€å®¡è®¡ã€æƒé™æ£€æŸ¥ï¼‰æ— æ³•é€šç”¨

âœ… â€œç»Ÿä¸€ä½¿ç”¨ ClaimTypes.NameIdentifierâ€ çš„åšæ³•
ç¬¬ä¸€æ­¥ï¼šåœ¨ç”Ÿæˆ JWT æ—¶ï¼ŒæŠŠç”¨æˆ· ID å†™å…¥ ClaimTypes.NameIdentifier

csharp
var claims = new List<Claim>
{
new Claim(ClaimTypes.NameIdentifier, user.Id), // ğŸ‘ˆ å…³é”®ï¼šç”¨å’Œ Cookie ç›¸åŒçš„ Claim ç±»å‹
new Claim(ClaimTypes.Name, user.UserName)
};
ğŸ’¡ è™½ç„¶ JWT æ ‡å‡†æ¨èç”¨ subï¼Œä½†ä¸ºäº†å’Œ Cookie è®¤è¯è¡Œä¸ºä¸€è‡´ï¼Œæˆ‘ä»¬ä¸»åŠ¨é€‰æ‹©ä½¿ç”¨ .NameIdentifierã€‚
ç¬¬äºŒæ­¥ï¼šæ‰€æœ‰åœ°æ–¹éƒ½ç”¨åŒä¸€è¡Œä»£ç è·å–ç”¨æˆ· ID

csharp
string? userId = User.FindFirstValue(ClaimTypes.NameIdentifier);

æ— è®ºæ˜¯ï¼š
Razor Page
MVC Controllerï¼ˆå¸¦ [Authorize]ï¼‰
API Controllerï¼ˆå¸¦ [Authorize(AuthenticationSchemes = JwtBearerDefaults.AuthenticationScheme)]ï¼‰

âœ… éƒ½èƒ½æ­£ç¡®æ‹¿åˆ° AspNetUsers.Idï¼

ğŸ§© æŠ€æœ¯ç»†èŠ‚ï¼šClaimTypes.NameIdentifier æ˜¯ä»€ä¹ˆï¼Ÿ

å®ƒæ˜¯ä¸€ä¸ªå¸¸é‡å­—ç¬¦ä¸²ï¼š

csharp
public const string NameIdentifier = "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/nameidentifier";
ASP.NET Core Identity çš„ Cookie ç™»å½•é»˜è®¤ä¼šæ·»åŠ è¿™ä¸ª Claim
JWT é»˜è®¤ä¸ä¼šæ·»åŠ å®ƒï¼ˆé™¤éä½ æ‰‹åŠ¨åŠ ï¼‰
ä½†å®ƒåªæ˜¯ä¸€ä¸ªæ™®é€šçš„ Claim åç§°ï¼Œå®Œå…¨å¯ä»¥åœ¨ JWT ä¸­ä½¿ç”¨

æ‰€ä»¥ä½ åœ¨ JWT é‡ŒåŠ å®ƒï¼Œæ˜¯åˆæ³•ä¸”å®‰å…¨çš„ã€‚

ğŸ†š å¯¹æ¯”ï¼šä¸ç»Ÿä¸€ vs ç»Ÿä¸€

åœºæ™¯ ä¸ç»Ÿä¸€çš„åšæ³• ç»Ÿä¸€çš„åšæ³•
------ ------------- -----------
è·å–ç”¨æˆ· ID if (cookie) use NameIdentifier; else if (jwt) use Sub å§‹ç»ˆç”¨ NameIdentifier
å…¬å…±æœåŠ¡ï¼ˆå¦‚å®¡è®¡æ—¥å¿—ï¼‰ éœ€åˆ¤æ–­è®¤è¯ç±»å‹ ä¸€è¡Œä»£ç æå®š
æœªæ¥è¿ç§»ï¼ˆå¦‚å…¨åˆ‡ JWTï¼‰ å¤§é‡ä»£ç è¦æ”¹ å‡ ä¹ä¸ç”¨æ”¹

âœ… æœ€ä½³å®è·µç¤ºä¾‹
1. JWT ç”Ÿæˆï¼ˆLogin APIï¼‰
csharp
var tokenDescriptor = new SecurityTokenDescriptor
{
Subject = new ClaimsIdentity(new[]
{
new Claim(ClaimTypes.NameIdentifier, user.Id), // â† ç»Ÿä¸€å…³é”®
new Claim(ClaimTypes.Name, user.UserName)
}),
Expires = DateTime.UtcNow.AddDays(7),
SigningCredentials = new SigningCredentials(key, SecurityAlgorithms.HmacSha256)
};
2. ä»»æ„æ§åˆ¶å™¨ä¸­è·å–ç”¨æˆ· ID
csharp
[Authorize]
public class AnyController : ControllerBase
{
public IActionResult GetUserData()
{
string? userId = User.FindFirstValue(ClaimTypes.NameIdentifier);
// æ— è®º Cookie è¿˜æ˜¯ JWTï¼Œéƒ½èƒ½æ‹¿åˆ°ï¼
return Ok(new { UserId = userId });
}
}

âš ï¸ æ³¨æ„äº‹é¡¹

1. ä¸è¦æ··ç”¨ sub å’Œ NameIdentifierï¼šé€‰ä¸€ä¸ªï¼ŒåšæŒåˆ°åº•ã€‚
2. ç¡®ä¿ JWT é…ç½®æ­£ç¡®ï¼šAddJwtBearer ä¸ä¼šè‡ªåŠ¨æ˜ å°„ sub åˆ° NameIdentifierï¼Œé™¤éä½ é…ç½®äº† TokenValidationParameters çš„ NameClaimTypeã€‚
csharp
// å¯é€‰ï¼šè®© JWT çš„ "sub" è‡ªåŠ¨å˜æˆ NameIdentifier
services.AddAuthentication(...)
.AddJwtBearer(options =>
{
options.TokenValidationParameters = new TokenValidationParameters
{
NameClaimType = ClaimTypes.NameIdentifier // â† è¿™æ · JWT çš„ "sub" ä¼šè¢«å½“ä½œ NameIdentifier
};
});

ä½†è¿™ç§æ–¹å¼ç¨å¤æ‚ï¼Œç›´æ¥åœ¨ Token é‡Œå†™ NameIdentifier æ›´ç›´è§‚ã€‚

âœ… æ€»ç»“
â€œç»Ÿä¸€ä½¿ç”¨ ClaimTypes.NameIdentifierâ€ = è®© Cookie å’Œ JWT åœ¨åº”ç”¨å±‚è¡¨ç°ä¸€è‡´ï¼Œç®€åŒ–ä»£ç ï¼Œæé«˜å¯ç»´æŠ¤æ€§ã€‚

åªè¦ä½ åœ¨ç”Ÿæˆ JWT æ—¶æ˜¾å¼åŠ å…¥ new Claim(ClaimTypes.NameIdentifier, user.Id)ï¼Œåç»­æ‰€æœ‰ä»£ç å°±å¯ä»¥æ— å·®åˆ«åœ°ä½¿ç”¨ï¼š

csharp
User.FindFirstValue(ClaimTypes.NameIdentifier)

æ¥è·å–å½“å‰ç”¨æˆ·çš„ AspNetUsers.Idï¼Œæ— è®ºè®¤è¯æ–¹å¼æ˜¯ä»€ä¹ˆã€‚

è¿™æ­£æ˜¯ä¼ä¸šçº§åº”ç”¨ä¸­â€œå…³æ³¨ç‚¹åˆ†ç¦»â€å’Œâ€œä¸€è‡´æ€§è®¾è®¡â€çš„ä½“ç°ã€‚
