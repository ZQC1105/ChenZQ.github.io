
  ## PropertyMetadata - FrameworkPropertyMetadata


在 WPF 中，PropertyMetadata 和 FrameworkPropertyMetadata 是用于定义依赖属性（Dependency Property） 行为的元数据类。它们是依赖属性系统的核心组成部分，允许你在注册属性时指定其默认行为和特性。

简单来说：
PropertyMetadata 是基础类，提供基本的功能。
FrameworkPropertyMetadata 是 PropertyMetadata 的派生类，增加了 WPF 框架特有的、更高级的功能。

下面我们详细阐述两者的区别、用途和关键属性。

1. PropertyMetadata (基础元数据)

这是所有元数据的基类。当你使用 DependencyProperty.Register 方法注册一个依赖属性时，通常会传入一个 PropertyMetadata 实例。
主要用途：
指定依赖属性的默认值。
注册属性值变更回调 (PropertyChangedCallback)。
注册属性值强制回调 (CoerceValueCallback)。
构造函数示例：
```csharp
public static readonly DependencyProperty MyPropertyProperty =
DependencyProperty.Register(
"MyProperty",
typeof(string),
typeof(MyControl),
new PropertyMetadata("DefaultValue", OnMyPropertyChanged, OnCoerceMyProperty)
);

private static void OnMyPropertyChanged(DependencyObject d, DependencyPropertyChangedEventArgs e)
{
// 当 MyProperty 的值发生变化时调用
}

private static object OnCoerceMyProperty(DependencyObject d, object baseValue)
{
// 在值被设置前进行强制处理
return baseValue;
}
```
关键成员：
DefaultValue: 属性的默认值。
PropertyChangedCallback: 值变化时的回调委托。
CoerceValueCallback: 值强制时的回调委托。
注意：PropertyMetadata 不包含任何与 UI 渲染、布局或继承相关的标志位。

2. FrameworkPropertyMetadata (框架级元数据)

这是 PropertyMetadata 的子类，专为 WPF 框架设计。当你使用 DependencyProperty.RegisterAttached 或 DependencyProperty.Register 但需要更高级的 WPF 特性时，可以使用它。通常在创建控件或需要精细控制属性行为时使用。
主要用途：
除了继承 PropertyMetadata 的所有功能外，FrameworkPropertyMetadata 还能控制：
属性值继承 (Inheritance)
影响布局 (Affects Arrange, Measure)
影响渲染 (Affects Render)
Bypass Layout Rounding
默认绑定模式 (如 OneWay, TwoWay)
是否支持数据绑定的 UpdateSourceTrigger
构造函数示例：
```csharp
public static readonly DependencyProperty BackgroundProperty =
DependencyProperty.Register(
"Background",
typeof(Brush),
typeof(Control),
new FrameworkPropertyMetadata(
defaultValue: null,
flags: FrameworkPropertyMetadataOptions.AffectsRender FrameworkPropertyMetadataOptions.Inherits,
propertyChangedCallback: OnBackgroundChanged
)
);
```
关键成员（除继承自 PropertyMetadata 的成员外）：

属性/标志位 说明
:--- :---
AffectsArrange 如果该属性改变，将触发父元素的 Arrange 过程。例如 Margin 改变会影响布局。
AffectsMeasure 如果该属性改变，将触发父元素的 Measure 过程。例如 Width 或 Height 改变会影响测量。
AffectsParentArrange 子元素的该属性改变会影响父元素的 Arrange。
AffectsParentMeasure 子元素的该属性改变会影响父元素的 Measure。
AffectsRender 属性改变会影响 UI 渲染，触发 OnRender。例如 Background、Foreground。
Inherits 启用属性值继承。子元素会自动继承父元素的该属性值（如果未显式设置）。例如 FontSize、FontFamily。
BindsTwoWayByDefault 默认绑定模式为 TwoWay。适合用户可编辑的属性，如 TextBox.Text。
Journal 该属性值应被导航历史记录（Journal）跟踪。
NotDataBindable 明确表示该属性不支持数据绑定（很少用）。
OverridesInheritanceBehavior 该属性会阻止属性值继承的继续传播。
SubPropertiesDoNotAffectRender 即使该属性的对象的子属性（如 Brush.Color）改变，也不触发渲染更新（优化性能）。

何时使用哪个？

场景 推荐使用
:--- :---
创建一个简单的自定义控件属性，只需默认值和变化回调。 ✅ PropertyMetadata
属性改变会影响布局（如大小、位置）。 ✅ FrameworkPropertyMetadata (使用 AffectsMeasure, AffectsArrange)
属性改变会影响外观（如颜色、背景）。 ✅ FrameworkPropertyMetadata (使用 AffectsRender)
希望属性支持值继承（如字体、语言）。 ✅ FrameworkPropertyMetadata (使用 Inherits)
创建类似 Text、IsChecked 这样通常双向绑定的属性。 ✅ FrameworkPropertyMetadata (使用 BindsTwoWayByDefault)
开发 WPF 内部控件或需要精细控制框架行为。 ✅ FrameworkPropertyMetadata

总结对比表

特性 PropertyMetadata FrameworkPropertyMetadata
:--- :--- :---
继承自 - PropertyMetadata
是否支持 AffectsMeasure / Arrange ❌ ✅
是否支持 AffectsRender ❌ ✅
是否支持 Inherits (值继承) ❌ ✅
是否支持 BindsTwoWayByDefault ❌ ✅
是否支持 SubPropertiesDoNotAffectRender ❌ ✅
使用场景 基础属性行为 WPF 框架级高级行为

最佳实践

1. 优先考虑 FrameworkPropertyMetadata：如果你在开发 WPF 控件，大多数情况下应该使用 FrameworkPropertyMetadata，因为它提供了更完整的控制。
2. 合理使用标志位：正确设置 AffectsMeasure、AffectsArrange、AffectsRender 可以确保布局和渲染系统高效工作，避免不必要的重绘。
3. 启用继承：对于字体、文本对齐等全局性属性，启用 Inherits 可以极大提升开发体验。
4. 默认双向绑定：对于用户输入类属性（如 Text），设置 BindsTwoWayByDefault 是符合直觉的。

理解 PropertyMetadata 和 FrameworkPropertyMetadata 的区别，是掌握 WPF 自定义控件开发和性能优化的关键一步。
