# PropertyMetadata 与 FrameworkPropertyMetadata

WPF 中定义依赖属性行为的两个元数据类，后者是前者的扩展，提供 WPF 框架特有功能。

---

## 1. PropertyMetadata（基础元数据）

所有元数据的基类，提供基本功能。

**用途**：
- 指定依赖属性默认值
- 注册 `PropertyChangedCallback`
- 注册 `CoerceValueCallback`

**构造函数示例**：
```csharp
public static readonly DependencyProperty MyPropertyProperty =
    DependencyProperty.Register(
        "MyProperty",
        typeof(string),
        typeof(MyControl),
        new PropertyMetadata(
            "DefaultValue", 
            OnMyPropertyChanged, 
            OnCoerceMyProperty
        )
    );
```

**关键成员**：
- `DefaultValue`：属性默认值
- `PropertyChangedCallback`：值变化回调
- `CoerceValueCallback`：值强制回调

**注意**：不包含任何与 UI 渲染、布局或继承相关的标志位。

---

## 2. FrameworkPropertyMetadata（框架级元数据）

`PropertyMetadata` 的子类，专为 WPF 框架设计，提供更精细的属性行为控制。

**构造函数示例**：
```csharp
public static readonly DependencyProperty BackgroundProperty =
    DependencyProperty.Register(
        "Background",
        typeof(Brush),
        typeof(Control),
        new FrameworkPropertyMetadata(
            null,
            FrameworkPropertyMetadataOptions.AffectsRender | 
            FrameworkPropertyMetadataOptions.Inherits,
            OnBackgroundChanged
        )
    );
```

**关键标志位**：

| 标志位                           | 说明                                                        |
| :------------------------------- | :---------------------------------------------------------- |
| `AffectsArrange`                 | 属性改变触发父元素 Arrange 过程（如 `Margin`）              |
| `AffectsMeasure`                 | 属性改变触发父元素 Measure 过程（如 `Width`、`Height`）     |
| `AffectsParentArrange`           | 子元素属性改变影响父元素 Arrange                            |
| `AffectsParentMeasure`           | 子元素属性改变影响父元素 Measure                            |
| `AffectsRender`                  | 属性改变触发 UI 重绘（如 `Background`、`Foreground`）       |
| `Inherits`                       | **启用属性值继承**，子元素自动继承父元素值（如 `FontSize`） |
| `BindsTwoWayByDefault`           | 默认双向绑定，适合用户可编辑属性（如 `TextBox.Text`）       |
| `Journal`                        | 属性值被导航历史记录（Journal）跟踪                         |
| `NotDataBindable`                | 明确表示该属性不支持数据绑定（极少用）                      |
| `OverridesInheritanceBehavior`   | 阻止属性值继承继续传播                                      |
| `SubPropertiesDoNotAffectRender` | 即使属性的子属性改变也不触发渲染更新（性能优化）            |

---

## 何时使用哪个？

| 场景                                    | 推荐                                                             |
| :-------------------------------------- | :--------------------------------------------------------------- |
| 简单自定义属性，仅需默认值和变化回调    | ✅ `PropertyMetadata`                                             |
| 属性改变影响布局（大小、位置）          | ✅ `FrameworkPropertyMetadata`（`AffectsMeasure/AffectsArrange`） |
| 属性改变影响外观（颜色、背景）          | ✅ `FrameworkPropertyMetadata`（`AffectsRender`）                 |
| 希望属性支持值继承（字体、语言）        | ✅ `FrameworkPropertyMetadata`（`Inherits`）                      |
| 类似 `Text`、`IsChecked` 等双向绑定属性 | ✅ `FrameworkPropertyMetadata`（`BindsTwoWayByDefault`）          |
| 开发 WPF 内部控件或需精细控制框架行为   | ✅ `FrameworkPropertyMetadata`                                    |

---

## 核心对比

| 特性              | PropertyMetadata | FrameworkPropertyMetadata |
| :---------------- | :--------------- | :------------------------ |
| **继承自**        | -                | `PropertyMetadata`        |
| **布局/渲染标志** | ❌                | ✅                         |
| **值继承**        | ❌                | ✅                         |
| **默认绑定模式**  | ❌                | ✅                         |
| **适用场景**      | 基础属性行为     | WPF 框架级高级行为        |

---

## 最佳实践

1. **优先使用 `FrameworkPropertyMetadata`**：开发 WPF 控件时，它提供更完整控制
2. **合理设置标志位**：正确配置 `AffectsMeasure`、`AffectsRender` 可确保布局渲染系统高效工作，避免不必要重绘
3. **按需启用继承**：对字体、文本对齐等全局性属性启用 `Inherits`，提升开发体验
4. **双向绑定默认值**：用户输入类属性（如 `Text`）应设置 `BindsTwoWayByDefault`

理解两者的区别，是掌握 WPF 自定义控件开发和性能优化的关键一步。